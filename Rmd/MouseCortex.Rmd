---
title: "Exp1"
author: "MatteoAndriolo"
output: 
  html_document: 
    toc: true
    toc_depth: 3
    number_sections: true
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r setup}
library(Seurat)
library(ggplot2)
library(here)
library(archetypes)
library(tidyr)
library(dplyr)
if (!require(gdata)) {
  install.packages("gdata")
}
library("gdata")

if (!require(kneedle)) {
  install.packages("quantmod")
}
devtools::install_github("etam4260/kneedle")
library(kneedle)

HVF <- TRUE
TEST <- FALSE

TEST_genes <- 300
TEST_samples <- 500
```

# Load Dataset
```{r Load Exp1 dataset, message=TRUE, warning=TRUE}
# Data definitions and loading
out_path <- "../out/MouseCortex"
load("../data/MouseCortex/MouseCortex.RData")
MouseCortex <- MouseCortex
mv("MouseCortex", "se")

# Manually generate Seurat Object S5
raw_counts <- se@raw.data
normalized_data <- se@data
scaled_data <- se@scale.data
var_genes <- se@var.genes
meta_data <- se@meta.data
se.ident <- se@ident
rm(se)

se <- CreateSeuratObject(counts = raw_counts, meta.data = meta_data)
rm(raw_counts, meta_data)
se[["RNA"]] <- SetAssayData(se[["RNA"]], layer = "data", new.data = normalized_data)
rm(normalized_data)
se[["RNA"]] <- SetAssayData(se[["RNA"]], layer = "scale.data", new.data = scaled_data)
rm(scaled_data)
VariableFeatures(se) <- var_genes
rm(var_genes)
Idents(se) <- se.ident
rm(se.ident)

if (TEST) {
  tgenes <- min(TEST_genes, nrow(se))
  tsamples <- min(TEST_samples, ncol(se))
  se <- se[1:tgenes, 1:tsamples]
  rm(tgenes, tsamples)
  se <- se[Matrix::rowSums(se) > 0, Matrix::colSums(se) > 0]
}

se <- FindVariableFeatures(se)
# se <- RunPCA(se)
se <- RunPCA(se, features = VariableFeatures(se))
se <- RunTSNE(se)
se <- RunUMAP(se, features = VariableFeatures(se))
```

# Visualize data
```{r Elbowplot and Visualization, message=TRUE, warning=TRUE}
imgname <- sprintf("%s/PCA.png", out_path)
message(sprintf("Saving Imagine --- %s", imgname))
pcaplot <- PCAPlot(se)
# ggsave(imgname, plot=pcaplot)
pcaplot
```

```{r UMAP, message=TRUE, warning=TRUE}
imgname <- sprintf("%s/UMAP.png", out_path)
message(sprintf("Saving Imagine --- %s", imgname))
umapplot <- UMAPPlot(se)
# ggsave(imgname, plot=umapplot)
umapplot
```

```{r Elbowplot, message=TRUE}
imgname <- sprintf("%s/elbow.pdf", out_path)
message(sprintf("Saving Imagine --- %s", imgname))
elbowplot <- ElbowPlot(se)
# ggsave(imgname, plot=elbowplot)
elbowplot
```


# Archetypes
```{r AA, message=TRUE, warning=TRUE}
k <- 5
k <- kneedle(elbowplot$data$dims, elbowplot$data$stdev)[1]

if (HVF) {
  m <- se@assays$RNA@layers$counts[which(se@assays$RNA@meta.data$vf_vst_counts_rank > 0), ]
} else {
  m <- se@assays$RNA@layers$counts
}
m <- m[Matrix::rowSums(m) > 0, Matrix::colSums(m) > 0]
m <- as.matrix(m)

s <- timestamp()
a <- archetypes::archetypes(m, k = k, verbose = TRUE, maxIterations = 10)
e <- timestamp()

save(a, file = sprintf("%s/Archetypes_%2d.rds", out_path, k))
```

## Visualize Archetypes
```{r Visualize AA, message=TRUE, warning=TRUE}
imgname <- sprintf("%s/Archetypes_%2d.png", out_path, k)
plotarchetyps <- xyplot(a, m)
# ggsave(imgname, plot=plotarchetyps)
plotarchetyps
```

# Seurat
```{r}
DimPlot(se, reduction = "umap")
# DimPlot(se, reduction = "umap", group.by = "Time_points")
```

```{r}
se <- FindNeighbors(se, dims = 6:15)
se <- FindClusters(se, resolution = 0.5)
```
