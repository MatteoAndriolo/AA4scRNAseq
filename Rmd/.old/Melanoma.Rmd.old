---
title: "Melanoma"
author: "MatteoAndriolo"
output: 
  html_document: 
    toc: true
    toc_depth: 3
    number_sections: true
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r setup}
# Placed inside Rprofile
library(Seurat)
library(ggplot2)
library(here)
library(archetypes)
library(tidyr)
library(dplyr)
if (!require(kneedle)) {
  install.packages("quantmod")
}
devtools::install_github("etam4260/kneedle")
library(kneedle)
library(cowplot)

HVF <- TRUE
TEST <- TRUE 
TEST <- FALSE

TEST_genes <- 300
TEST_samples <- 500
```

# Load Dataset
```{r Load Melanoma dataset, warning=FALSE, error=FALSE, message=FALSE,results='hide'}
data_path <- "../data/Melanoma/GSE72056_melanoma_single_cell_revised_v2.txt"
out_path <- "../out/Melanoma"

se <- read.table(data_path, header = TRUE)
se <- se[!duplicated(se[, 1]), ] # remove duplicated genes
rownames(se) <- se[, 1] # extract from matrix rownames
se <- se[, 2:ncol(se)] # elide rownames from gene expression matrix

metadata <- se[1:3, ] # extract metadata
metadata <- t(metadata) %>%
  data.frame() %>%
  mutate(across(where(is.character), as.numeric))

se <- se[4:nrow(se), ]
se <- se %>%
  data.frame() %>%
  mutate(across(where(is.character), as.numeric))
# -------- END BASIC SETUP
se <- se[Matrix::rowSums(se) > 0, Matrix::colSums(se) > 0]

if (TEST) {
  tgenes <- min(TEST_genes, nrow(se))
  tsamples <- min(TEST_samples, ncol(se))
  metadata <- metadata[1:tsamples, ]
  se <- se[1:tgenes, 1:tsamples]
  rm(tgenes, tsamples)
  se <- se[Matrix::rowSums(se) > 0, Matrix::colSums(se) > 0]
}

se <- CreateSeuratObject(counts = se, meta.data = metadata)
se <- ScaleData(se, layer = "counts")
se <- FindVariableFeatures(se)

se <- RunPCA(se, features = VariableFeatures(se))
se <- RunUMAP(se, features = VariableFeatures(se))
```
# Visualize data

```{r}
# Generate the PCA plot
imgname_pca <- sprintf("%s/PCA.png", out_path)
message(sprintf("Saving Image --- %s", imgname_pca))
pcaplot <- PCAPlot(se)

# Generate the UMAP plot
imgname_umap <- sprintf("%s/UMAP.png", out_path)
message(sprintf("Saving Image --- %s", imgname_umap))
umapplot <- UMAPPlot(se)

# Combine the two plots using cowplot
combined_plot <- plot_grid(pcaplot, umapplot, labels = c("A", "B"))

# Save the combined plot
combined_imgname <- sprintf("%s/Combined_Plots.png", out_path)
message(sprintf("Saving Image --- %s", combined_imgname))
ggsave(combined_imgname, plot = combined_plot)

# Display the combined plot
print(combined_plot)

```

```{r Elbowplot, message=TRUE}
imgname <- sprintf("%s/elbow.pdf", out_path)
message(sprintf("Saving Imagine --- %s", imgname))
elbowplot <- ElbowPlot(se)
# ggsave(imgname, plot=elbowplot)
elbowplot
```


# Archetypes
```{r AA, message=TRUE, warning=TRUE}
k <- 5
k <- kneedle(elbowplot$data$dims, elbowplot$data$stdev)[1]
message(sprintf("k=%d", k))

if (HVF) {
  m <- se@assays$RNA@layers$counts[which(se@assays$RNA@meta.data$vf_vst_counts_rank > 0), ]
  se.large <- se
  se <- se[which(se@assays$RNA@meta.data$vf_vst_counts_rank > 0), ]
} else {
  m <- se@assays$RNA@layers$counts
}
m <- m[Matrix::rowSums(m) > 0, Matrix::colSums(m) > 0]
m <- as.matrix(m)

s <- timestamp()
a <- archetypes::archetypes(m, k = k, verbose = TRUE, maxIterations = 10, saveHistory = TRUE)
e <- timestamp()

#save(a, file = sprintf("%s/Archetypes_%2d.rds", out_path, k))
```

## Visualize Archetypes
```{r Visualize AA, message=TRUE, warning=TRUE}
imgname <- sprintf("%s/Archetypes_%2d.png", out_path, k)
plotarchetyps <- xyplot(a, m)
# ggsave(imgname, plot=plotarchetyps)
plotarchetyps
```

```{r}
simplexplot(a)
```

```{r}
#simplex_projection(a)
```

## Plot Umap Archetypes
```{r}
source("../src/R/tools.R")
TH_archetypes.umap(se,a,out_path)

```
```{r}
umap_result <- UMAPPlot(se)
umap_data <- as.data.frame(umap_result$data)[,1:2]
colnames(umap_data) <- c("UMAP1", "UMAP2")
threshold <- 0.2

# Get the archetype weights
weights <- coef(a)
weights <- as.data.frame(weights)
# Set a minimum threshold
weights[weights < threshold] <- 0

column_sums <- colSums(a$archetypes)  # Sum of each column
normalized_mat <- sweep(a$archetypes, 2, column_sums, FUN = "/")  # Divide each element by its column sum
weights=as.data.frame(normalized_mat)

plot_list <- list()
# Plotting
for (i in 1:k) {
  umap_data$weight <- t(weights[i,])
  plot_title <- sprintf("UMAP Archetype %d", i)
  imgname <- sprintf("%s/UMAP_Archetype_%d.png", out_path, i)
  
  umap_plot <- ggplot(umap_data, aes(x = UMAP1, y = UMAP2, color = weight)) +
    geom_point(size = 1) +
    scale_color_gradient(low = "grey", high = "red") +
    ggtitle(plot_title) +
    labs(color = "Weight")
  #ggsave(imgname, plot = umap_plot)
  
  #message(sprintf("Saving Image --- %s", imgname))
  plot_list[[i]] <- umap_plot
}

# Combine all plots into a single image
combined_plot <- plot_grid(plotlist = plot_list, ncol = 2)

# Save the combined image
combined_imgname <- sprintf("%s/UMAP_Combined.png", out_path)
combined_plot
ggsave(combined_imgname, plot = combined_plot, width = 12, height = 8)
message(sprintf("Saving Combined Image --- %s", combined_imgname))
```

# Seurat
```{r}
DimPlot(se, reduction = "umap")
DimPlot(se, reduction = "umap", group.by = "cell_type")
```

```{r}
se <- FindNeighbors(se, dims = 6:15)
se <- FindClusters(se, resolution = 0.5)
```
